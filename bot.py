import os
from telegram import Bot
from apscheduler.schedulers.blocking import BlockingScheduler
from dotenv import load_dotenv
from datetime import datetime, timedelta
from pathlib import Path
import asyncio
import openai

# Always load .env from the script's directory
load_dotenv(dotenv_path=Path(__file__).parent / '.env')

TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
CHAT_ID = os.getenv('CHAT_ID')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

print(f"Loaded token: {TELEGRAM_BOT_TOKEN!r}")
print(f"Loaded chat id: {CHAT_ID!r}")

if not TELEGRAM_BOT_TOKEN or not CHAT_ID:
    print("Error: TELEGRAM_BOT_TOKEN or CHAT_ID is not set. Please check your .env file.")
    exit(1)

bot = Bot(token=TELEGRAM_BOT_TOKEN)

PROMPT = '''Контекст: Я инвестор/аналитик, которому необходимо ежедневно быть в курсе последних событий и трендов на криптовалютном рынке для принятия обоснованных инвестиционных решений.

Задачи для ИИ:

Сбор новостей:

Проанализируй новостные источники (например, Cointelegraph, CoinDesk, Bloomberg Crypto, Decrypt, The Block, РБК Крипто, ForkLog и другие авторитетные международные и русскоязычные ресурсы) за последние 24 часа.
Для каждой из следующих криптовалют – Bitcoin (BTC), Ethereum (ETH), Solana (SOL), THORChain (RUNE), Arbitrum (ARB), Tether (USDT) – выдели 1-2 самые важные новости.
Представь новость в виде краткой выжимки (1-2 предложения), отражающей суть события.
Анализ и прогнозы:

На основе анализа авторитетных источников (технический анализ, мнения экспертов, аналитические отчеты) предоставь долгосрочный прогноз (перспектива 6-12 месяцев и более) для каждой из указанных криптовалют (BTC, ETH, SOL, RUNE, ARB).
Укажи общее настроение рынка по отношению к каждой монете: "Strong Buy" (Активная покупка), "Buy" (Покупать), "Neutral" (Нейтрально), "Sell" (Продавать), "Strong Sell" (Активная продажа). Аргументируй кратко (1 предложение) свой выбор, ссылаясь на ключевые факторы (например, технологическое развитие, партнерства, макроэкономические факторы, регуляторные изменения).
Для USDT укажи информацию о стабильности, объеме капитализации и возможных рисках или изменениях в регулировании, если таковые имеются.
Перспективные криптовалюты:

Определи 2-3 криптовалюты (не из основного списка), которые показывают высокий потенциал роста или представляют интерес с точки зрения технологии/инноваций на ближайшие месяцы.
Кратко (1-2 предложения на каждую) опиши, почему эти криптовалюты считаются перспективными (например, новый проект с сильной командой, решение актуальной проблемы, предстоящий важный апдейт, растущее сообщество).
Укажи, на каких биржах они торгуются (если это возможно и релевантно).
Формат ответа:

Отчет должен быть структурирован следующим образом:

Ежедневный криптовалютный отчет

Дата: [Автоматически подставить текущую дату]

I. Основные криптовалюты:

Bitcoin (BTC)

Новости:
[Краткая выжимка новости 1]
[Краткая выжимка новости 2 (если есть)]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Neutral/Sell/Strong Sell]
Обоснование: [Краткое обоснование прогноза]
Ethereum (ETH)

Новости:
[Краткая выжимка новости 1]
[Краткая выжимка новости 2 (если есть)]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Neutral/Sell/Strong Sell]
Обоснование: [Краткое обоснование прогноза]
Solana (SOL)

Новости:
[Краткая выжимка новости 1]
[Краткая выжимка новости 2 (если есть)]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Neutral/Sell/Strong Sell]
Обоснование: [Краткое обоснование прогноза]
THORChain (RUNE)

Новости:
[Краткая выжимка новости 1]
[Краткая выжимка новости 2 (если есть)]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Neutral/Sell/Strong Sell]
Обоснование: [Краткое обоснование прогноза]
Arbitrum (ARB)

Новости:
[Краткая выжимка новости 1]
[Краткая выжимка новости 2 (если есть)]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Neutral/Sell/Strong Sell]
Обоснование: [Краткое обоснование прогноза]
Tether (USDT)

Новости/Статус:
[Информация о стабильности, капитализации, аудите, рисках или регуляторных изменениях]
II. Перспективные криптовалюты для инвестирования:

[Название криптовалюты 1 (Тикер)]

Описание: [Почему перспективна]
Где торгуется (примеры): [Биржи]
[Название криптовалюты 2 (Тикер)]

Описание: [Почему перспективна]
Где торгуется (примеры): [Биржи]
[Название криптовалюты 3 (Тикер)] (если есть)

Описание: [Почему перспективна]
Где торгуется (примеры): [Биржи]

Дополнительные инструкции для ИИ:

Старайся использовать самые свежие данные.
Избегай предвзятости и основывай прогнозы на фактах и аналитике.
Если по какой-то криптовалюте нет значимых новостей или четких прогнозов, укажи это.
Ответ должен быть юзер френдли
Язык отчета – русский.
'''

PROMPT_17_00 = '''Промпт для ежедневного сбора саммари по портфелю акций

Цель: Получить ежедневный структурированный отчет по ключевым акциям в портфеле (JNJ, NVDA, GOOGL, UNH, BRK.B) и перспективным акциям для инвестирования. Отчет должен включать краткие новостные сводки, долгосрочные прогнозы (покупка/продажа) с обоснованиями и рекомендации по новым инвестиционным возможностям.

Контекст: Я инвестор/аналитик, которому необходимо ежедневно быть в курсе последних событий и трендов на фондовом рынке для принятия обоснованных инвестиционных решений по моему портфелю и поиска новых возможностей.

Задачи для ИИ:

Сбор новостей по позициям в портфеле:

Проанализируй авторитетные финансовые новостные источники (например, Bloomberg, Reuters, Wall Street Journal, Financial Times, Yahoo Finance, Seeking Alpha, РБК Инвестиции, finanz.ru и другие) за последние 24 часа.
Для каждой из следующих акций в портфеле – Johnson & Johnson (JNJ), NVIDIA Corporation (NVDA), Alphabet Inc. (GOOGL), UnitedHealth Group (UNH), Berkshire Hathaway Inc. Class B (BRK.B) – выдели 1-2 самые важные новости (например, отчеты о доходах, крупные контракты, изменения в руководстве, регуляторные новости, аналитические обзоры, значимые движения котировок, новости сектора, влияющие на компанию).
Представь новость в виде краткой выжимки (1-2 предложения), отражающей суть события и его потенциальное влияние на компанию.
Анализ и прогнозы по позициям в портфеле:

На основе анализа отчетов аналитиков, консенсус-прогнозов, фундаментальных показателей компании (P/E, EPS, прогнозы роста и т.д.) и технического анализа (если применимо для долгосрочного взгляда) предоставь долгосрочный прогноз (перспектива 6-12 месяцев и более) для каждой из указанных акций.
Укажи общее настроение аналитиков/рынка по отношению к каждой акции: "Strong Buy" (Активная покупка), "Buy" (Покупать), "Hold" (Держать), "Sell" (Продавать), "Strong Sell" (Активная продажа).
Обоснуй свой прогноз для каждой акции (1-2 предложения), ссылаясь на ключевые факторы (например, финансовые результаты, рыночные позиции, инновации, дивидендная политика, риски, оценка по мультипликаторам).
Перспективные акции для инвестирования:

Определи 2-3 акции (не из основного списка портфеля), которые, по мнению аналитиков или исходя из текущих рыночных трендов и фундаментальных показателей, показывают высокий потенциал роста или представляют интерес с точки зрения долгосрочного инвестирования.
Обоснуй (2-3 предложения на каждую акцию), почему эти акции считаются перспективными (например, недооцененность, сильные финансовые показатели, прорывные технологии, ожидаемый рост сектора, новые продукты, M&A активность).
Укажи отрасль и кратко рыночную капитализацию (если это значимо для контекста).
Формат ответа:

Отчет должен быть структурирован следующим образом:

Ежедневный отчет по портфелю акций

Дата: [Автоматически подставить текущую дату]

I. Анализ акций в портфеле:

Johnson & Johnson (JNJ)

Новости:
[Краткая выжимка новости 1. Потенциальное влияние: ...]
[Краткая выжимка новости 2 (если есть). Потенциальное влияние: ...]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Hold/Sell/Strong Sell]
Обоснование прогноза: [Обоснование, основанное на финансовых показателях, рыночных позициях, новостях и аналитических мнениях.]
NVIDIA Corporation (NVDA)

Новости:
[Краткая выжимка новости 1. Потенциальное влияние: ...]
[Краткая выжимка новости 2 (если есть). Потенциальное влияние: ...]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Hold/Sell/Strong Sell]
Обоснование прогноза: [Обоснование, основанное на финансовых показателях, инновациях в области ИИ и гейминга, конкурентной среде и аналитических мнениях.]
Alphabet Inc. (GOOGL)

Новости:
[Краткая выжимка новости 1. Потенциальное влияние: ...]
[Краткая выжимка новости 2 (если есть). Потенциальное влияние: ...]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Hold/Sell/Strong Sell]
Обоснование прогноза: [Обоснование, основанное на росте рекламного бизнеса, облачных сервисов, разработках в ИИ и регуляторных рисках.]
UnitedHealth Group (UNH)

Новости:
[Краткая выжимка новости 1. Потенциальное влияние: ...]
[Краткая выжимка новости 2 (если есть). Потенциальное влияние: ...]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Hold/Sell/Strong Sell]
Обоснование прогноза: [Обоснование, основанное на результатах в секторе здравоохранения, росте клиентской базы, регуляторных изменениях и эффективности Optum.]
Berkshire Hathaway Inc. Class B (BRK.B)

Новости:
[Краткая выжимка новости 1 (например, крупные инвестиции, выкуп акций, финансовые результаты дочерних компаний). Потенциальное влияние: ...]
[Краткая выжимка новости 2 (если есть). Потенциальное влияние: ...]
Долгосрочный прогноз (6-12+ мес.): [Strong Buy/Buy/Hold/Sell/Strong Sell]
Обоснование прогноза: [Обоснование, основанное на диверсифицированном портфеле, кэш-позиции, стратегии Уоррена Баффета и общих экономических перспективах.]
II. Перспективные акции для инвестирования:

[Название акции 1 (Тикер)]

Отрасль: [Название отрасли]
Обоснование перспективности: [Подробное обоснование, почему акция считается перспективной для долгосрочных инвестиций, включая ключевые драйверы роста и возможные риски.]
[Название акции 2 (Тикер)]

Отрасль: [Название отрасли]
Обоснование перспективности: [Подробное обоснование, почему акция считается перспективной для долгосрочных инвестиций, включая ключевые драйверы роста и возможные риски.]
[Название акции 3 (Тикер)] (если есть)

Отрасль: [Название отрасли]
Обоснование перспективности: [Подробное обоснование, почему акция считается перспективной для долгосрочных инвестиций, включая ключевые драйверы роста и возможные риски.]

Дополнительные инструкции для ИИ:

Используй только самые свежие и актуальные данные (за последние 24-48 часов для новостей).
Обоснования должны быть четкими, краткими и по существу.
Избегай спекулятивной информации без подтверждения из авторитетных источников.
Если по какой-то акции нет значимых уникальных новостей, можно указать общие настроения в секторе или недавние важные события, которые продолжают оказывать влияние.
Язык отчета – русский.
'''

client = openai.OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

async def send_openai_report():
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": PROMPT}],
            max_tokens=1500,
            temperature=0.7,
        )
        report = response.choices[0].message.content
        await bot.send_message(chat_id=CHAT_ID, text=report)
        print(f"Sent OpenAI report to {CHAT_ID} at {datetime.now()}")
    except Exception as e:
        print(f"Failed to send OpenAI report: {e}")

def send_openai_report_sync():
    try:
        asyncio.run(send_openai_report())
    except Exception as e:
        print(f"Failed to send OpenAI report: {e}")

async def send_openai_report_17_00():
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": PROMPT_17_00}],
            max_tokens=1500,
            temperature=0.7,
        )
        report = response.choices[0].message.content
        await bot.send_message(chat_id=CHAT_ID, text=report)
        print(f"Sent OpenAI report to {CHAT_ID} at {datetime.now()}")
    except Exception as e:
        print(f"Failed to send OpenAI report: {e}")

def send_openai_report_17_00_sync():
    try:
        asyncio.run(send_openai_report_17_00())
    except Exception as e:
        print(f"Failed to send OpenAI report: {e}")

scheduler = BlockingScheduler()
# Schedule the OpenAI report at 10:00 AM
scheduler.add_job(send_openai_report_sync, 'cron', hour=10, minute=0)

# Schedule the OpenAI report at 17:00 PM
scheduler.add_job(send_openai_report_17_00_sync, 'cron', hour=17, minute=0)

if __name__ == '__main__':
    print('Bot started. Waiting to send scheduled messages...')
    scheduler.start() 